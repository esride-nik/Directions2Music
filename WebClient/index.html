<!--

To run this demo, you need to replace 'YOUR_ACCESS_TOKEN' with an access token from ArcGIS that has the correct privileges.

To get started, sign up for a free ArcGIS Location Platform account or a free trial of ArcGIS Online and create developer credentials.

https://developers.arcgis.com/documentation/security-and-authentication/get-started/

-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1, maximum-scale=1,user-scalable=no"
    />
    <title>
      Directions component with RouteLayer | Sample | ArcGIS Maps SDK for
      JavaScript
    </title>

    <!-- Load Calcite components from CDN -->
    <script
      type="module"
      src="https://js.arcgis.com/calcite-components/3.3.3/calcite.esm.js"
    ></script>

    <!-- Load the ArcGIS Maps SDK for JavaScript from CDN -->
    <script src="https://js.arcgis.com/4.34/"></script>

    <!-- Load Map components from CDN-->
    <script
      type="module"
      src="https://js.arcgis.com/4.34/map-components/"
    ></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
    </style>
  </head>

  <body>
    <arcgis-map item-id="45b3b2fb35e94ab09381d0caa0da5946">
      <arcgis-directions slot="top-right"></arcgis-directions>
      <audio controls slot="bottom-right" id="audioPlayer">
        <source id="audioSource" src="" type="audio/mpeg">
      </audio>
    </arcgis-map>
    <script type="module">
      // call the orchestration endpoint of local MCP client
      async function generateMusic(directions) {
        const response = await fetch('http://localhost:3001/orchestrate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ directions, dummyMode: true })
        });
        
        const result = await response.json();
        if (result.success && result.audioUrl) {
          document.getElementById('audioSource').src = 
            `http://localhost:3001${result.audioUrl}`;
          document.querySelector('audio').load();
          document.querySelector('audio').play();
        }
      }

      // import RouteLayer module to load a RouteLayer from a portal item
      const RouteLayer = await $arcgis.import(
        "@arcgis/core/layers/RouteLayer.js"
      );
      // import esriConfig to set the API key
      const esriConfig = await $arcgis.import("@arcgis/core/config.js");

      // get access to the arcgis-map component element and arcgis-directions component
      const viewElement = document.querySelector("arcgis-map");
      const directionsElement = document.querySelector("arcgis-directions");

      // load application config (config.json) â€” same-origin fetch
      // Using top-level await in this module script ensures config is
      // available before we configure esriConfig.
      const configResp = await fetch(new URL("./config.json", import.meta.url));
      if (!configResp.ok) {
        console.warn(
          "Failed to load config.json, falling back to placeholder token"
        );
      }
      const appConfig = configResp.ok ? await configResp.json() : {};

      // define the API key and define their scopes (only for directions component)
      // config.json can provide either `apiKey` or `token` fields.
      const token = appConfig.apiKey || appConfig.token || "%YOUR_ACCESS_TOKEN%";
      esriConfig.apiKeys.scopes = [
        {
          token: token,
          urls: [
            "https://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer",
            "https://route-api.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World",
          ],
        },
      ];

      // wait for the map and directions and routeLayer to be ready
      // and load the RouteLayer
      await viewElement.viewOnReady();
      await directionsElement.componentOnReady();

      directionsElement.addEventListener("arcgisPropertyChange", (event) => {
        if (event.detail.name === "lastRoute") {
          const route = directionsElement.lastRoute;
          if (route) {
            console.log("New route:", route);
            console.log(route.directionPoints.items.map((pt) => pt.displayText));
            generateMusic(route.directionPoints.items.map((pt) => pt.displayText));
          }
        }
      });

      // assign the RouteLayer to the Directions component
      // and add the RouteLayer to the map
      const routeLayer = new RouteLayer();
      directionsElement.layer = routeLayer;
      viewElement.map.add(routeLayer);

    </script>
  </body>
</html>
