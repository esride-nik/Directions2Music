<!--

To run this demo, you need to replace 'YOUR_ACCESS_TOKEN' with an access token from ArcGIS that has the correct privileges.

To get started, sign up for a free ArcGIS Location Platform account or a free trial of ArcGIS Online and create developer credentials.

https://developers.arcgis.com/documentation/security-and-authentication/get-started/

-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1, maximum-scale=1,user-scalable=no"
    />
    <title>
      Directions component with RouteLayer | Sample | ArcGIS Maps SDK for
      JavaScript
    </title>

    <!-- Load Calcite components from CDN -->
    <script
      type="module"
      src="https://js.arcgis.com/calcite-components/3.3.3/calcite.esm.js"
    ></script>

    <!-- Load the ArcGIS Maps SDK for JavaScript from CDN -->
    <script src="https://js.arcgis.com/4.34/"></script>

    <!-- Load Map components from CDN-->
    <script
      type="module"
      src="https://js.arcgis.com/4.34/map-components/"
    ></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      
      /* Custom styles for Calcite components */
      calcite-panel[slot="top-left"] {
        max-width: 400px;
        min-width: 320px;
      }
    </style>
  </head>

  <body>
    <arcgis-map item-id="45b3b2fb35e94ab09381d0caa0da5946">
      <arcgis-directions slot="top-left"></arcgis-directions>
      
      <!-- Enhanced Music Generation Panel with Calcite Components -->
      <calcite-panel slot="bottom-right" heading="ðŸŽµ Directions2Music">
        
        <!-- Directions Accordion -->
        <calcite-accordion id="directionsAccordion" icon-type="chevron">
          <calcite-accordion-item heading="Route Directions" expanded>
            <calcite-text-area 
              id="directionsInput"
              placeholder="Route directions will appear here automatically when you plan a route..."
              rows="6"
              resize="vertical"
            ></calcite-text-area>
          </calcite-accordion-item>
        </calcite-accordion>
        
        <!-- Controls Section -->
        <div style="padding: 1rem;">
          <calcite-button 
            id="generateBtn" 
            icon-start="play" 
            scale="m" 
            width="full"
          >
            Generate Music
          </calcite-button>
          
          <!-- Checkboxes -->
          <div style="margin-top: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem;">
            <calcite-label layout="inline">
              <calcite-checkbox id="dummyMode" checked></calcite-checkbox>
              Fast Test Mode
            </calcite-label>
          </div>
        </div>
        
        <!-- Status Section -->
        <calcite-notice 
          id="statusSection" 
          kind="info" 
          scale="s" 
          style="display: none; margin: 1rem;"
        >
          <calcite-progress 
            id="progressBar" 
            type="indeterminate" 
            style="display: none; margin-top: 0.5rem;"
          ></calcite-progress>
        </calcite-notice>
        
        <!-- Style Info -->
        <calcite-card id="styleInfo" style="display: none; margin: 1rem;">
          <h4 slot="heading">Song Information</h4>
          <p>Style details will appear here</p>
        </calcite-card>
        
        <!-- Error Display -->
        <calcite-notice 
          id="errorMessage" 
          kind="danger" 
          scale="s" 
          style="display: none; margin: 1rem;"
        >
          <div id="errorContent"></div>
        </calcite-notice>
        
        <!-- Audio Player -->
        <div id="audioSection" style="padding: 1rem; display: none;">
          <calcite-label>Generated Music</calcite-label>
          <audio controls id="audioPlayer" style="width: 100%; margin-top: 0.5rem;">
            <source id="audioSource" src="" type="audio/mpeg">
          </audio>
        </div>
        
      </calcite-panel>
    </arcgis-map>
    <script type="module">
      // Async job queue system for music generation
      const API_BASE = 'http://localhost:3001';
      let currentJobId = null;
      let pollInterval = null;
      
      // DOM elements
      const directionsInput = document.getElementById('directionsInput');
      const generateBtn = document.getElementById('generateBtn');
      const dummyModeCheckbox = document.getElementById('dummyMode');
      const statusSection = document.getElementById('statusSection');
      const progressBar = document.getElementById('progressBar');
      const styleInfo = document.getElementById('styleInfo');
      const errorMessage = document.getElementById('errorMessage');
      const audioSection = document.getElementById('audioSection');
      const audioPlayer = document.getElementById('audioPlayer');
      const audioSource = document.getElementById('audioSource');

      // Show/hide UI elements  
      function showElement(element) { 
        if (element) element.style.display = 'block'; 
      }
      function hideElement(element) { 
        if (element) element.style.display = 'none'; 
      }

      // Update job status display using Calcite Notice
      function updateJobStatus(jobData) {
        const elapsed = jobData.elapsedTime ? Math.round(jobData.elapsedTime / 1000) : 0;
        
        // Update the status notice
        statusSection.kind = jobData.status === 'completed' ? 'success' : 
                            jobData.status === 'failed' ? 'danger' : 'info';
        statusSection.open = true;
        
        // Create status content
        const statusText = `Status: ${jobData.status.toUpperCase()}${elapsed > 0 ? ` â€¢ ${elapsed}s` : ''}`;
        const messageText = jobData.message || 'Processing...';
        
        // Update notice content
        statusSection.innerHTML = `
          <div slot="title">${statusText}</div>
          <div slot="message">${messageText}</div>
        `;
      }

      // Update progress - using Calcite Progress component
      function updateProgress(status, elapsedTime = 0) {
        if (progressBar) {
          if (status === 'pending') {
            progressBar.type = 'indeterminate';
            showElement(progressBar);
          } else if (status === 'processing') {
            // For processing, we can show determinate progress based on time
            const expectedDuration = dummyModeCheckbox.checked ? 10000 : 180000; // ms
            const progress = Math.min(90, (elapsedTime / expectedDuration) * 80 + 10);
            progressBar.type = 'determinate';
            progressBar.value = progress / 100; // Calcite expects 0-1 range
            showElement(progressBar);
          } else if (status === 'completed') {
            progressBar.type = 'determinate';
            progressBar.value = 1;
            setTimeout(() => hideElement(progressBar), 2000);
          } else if (status === 'failed') {
            hideElement(progressBar);
          }
        }
      }

      // Show style card information
      function showStyleCard(styleCardData) {
        if (!styleCardData || !styleInfo) return;
        
        // Update the style info card
        const heading = styleInfo.querySelector('h4[slot="heading"]');
        const details = styleInfo.querySelector('p');
        
        if (heading) heading.textContent = `ðŸŽ¨ ${styleCardData.songTitle}`;
        if (details) details.textContent = 
          `${styleCardData.genre} â€¢ ${styleCardData.artistName} â€¢ ${styleCardData.mood?.join(', ')}`;
        showElement(styleInfo);
      }

      // Show audio player
      function showAudio(audioUrl) {
        if (audioSource && audioPlayer && audioSection) {
          audioSource.src = audioUrl;
          audioPlayer.load();
          showElement(audioSection);
          audioPlayer.play().catch(e => console.log('Audio autoplay prevented'));
        }
      }

      // Show error message using Calcite Notice
      function showError(error) {
        if (errorMessage) {
          errorMessage.kind = 'danger';
          errorMessage.open = true;
          errorMessage.innerHTML = `
            <div slot="title">Error</div>
            <div slot="message">${error}</div>
          `;
        }
      }

      // Start music generation job
      async function generateMusic() {
        const directions = directionsInput.value.trim().split('\n').filter(line => line.trim());
        
        if (directions.length === 0) {
          showError('Please enter some navigation directions or plan a route');
          return;
        }

        // Reset UI
        generateBtn.loading = true;
        generateBtn.disabled = true;
        
        // Hide previous results
        if (errorMessage) errorMessage.open = false;
        hideElement(styleInfo);
        hideElement(progressBar);
        hideElement(audioSection);

        try {
          const response = await fetch(`${API_BASE}/orchestrate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              directions: directions,
              dummyMode: dummyModeCheckbox.checked
            })
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || 'Failed to start job');
          }

          currentJobId = result.jobId;
          generateBtn.loading = false;
          generateBtn.disabled = false;
          
          startPolling();

        } catch (error) {
          showError(error.message);
          generateBtn.loading = false;
          generateBtn.disabled = false;
        }
      }

      // Check job status
      async function checkJobStatus() {
        if (!currentJobId) return;

        try {
          const response = await fetch(`${API_BASE}/status/${currentJobId}`);
          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || 'Failed to check status');
          }

          updateJobStatus(result);
          updateProgress(result.status, result.elapsedTime);

          if (result.status === 'completed') {
            showStyleCard(result.styleCard);
            if (result.audioUrl) {
              showAudio(`${API_BASE}${result.audioUrl}`);
            }
            stopPolling();
          } else if (result.status === 'failed') {
            showError(result.error);
            stopPolling();
          }

        } catch (error) {
          showError(error.message);
          stopPolling();
        }
      }

      // Start polling for job status
      function startPolling() {
        if (pollInterval) clearInterval(pollInterval);
        checkJobStatus(); // Check immediately
        pollInterval = setInterval(checkJobStatus, 2000); // Then every 2 seconds
      }

      // Stop polling
      function stopPolling() {
        if (pollInterval) {
          clearInterval(pollInterval);
          pollInterval = null;
        }
      }

      // Event listeners
      generateBtn.addEventListener('click', generateMusic);
      
      // Cleanup on page unload
      window.addEventListener('beforeunload', stopPolling);

      // import RouteLayer module to load a RouteLayer from a portal item
      const RouteLayer = await $arcgis.import(
        "@arcgis/core/layers/RouteLayer.js"
      );
      // import esriConfig to set the API key
      const esriConfig = await $arcgis.import("@arcgis/core/config.js");

      // get access to the arcgis-map component element and arcgis-directions component
      const viewElement = document.querySelector("arcgis-map");
      const directionsElement = document.querySelector("arcgis-directions");

      // load application config (config.json) â€” same-origin fetch
      // Using top-level await in this module script ensures config is
      // available before we configure esriConfig.
      const configResp = await fetch(new URL("./config.json", import.meta.url));
      if (!configResp.ok) {
        console.warn(
          "Failed to load config.json, falling back to placeholder token"
        );
      }
      const appConfig = configResp.ok ? await configResp.json() : {};

      // define the API key and define their scopes (only for directions component)
      // config.json can provide either `apiKey` or `token` fields.
      const token = appConfig.apiKey || appConfig.token || "%YOUR_ACCESS_TOKEN%";
      esriConfig.apiKeys.scopes = [
        {
          token: token,
          urls: [
            "https://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer",
            "https://route-api.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World",
          ],
        },
      ];

      // wait for the map and directions and routeLayer to be ready
      // and load the RouteLayer
      await viewElement.viewOnReady();
      await directionsElement.componentOnReady();

      // Route event handler - populate directions textarea instead of generating music immediately
      directionsElement.addEventListener("arcgisPropertyChange", (event) => {
        if (event.detail.name === "lastRoute") {
          const route = directionsElement.lastRoute;
          if (route) {
            console.log("New route:", route);
            const directions = route.directionPoints.items.map((pt) => pt.displayText);
            console.log("Route directions:", directions);
            
            // Populate the directions textarea
            directionsInput.value = directions.join('\n');
            
            // Optional: Auto-generate if user wants (you can uncomment this line)
            // generateMusic();
          }
        }
      });

      // assign the RouteLayer to the Directions component
      // and add the RouteLayer to the map
      const routeLayer = new RouteLayer();
      directionsElement.layer = routeLayer;
      viewElement.map.add(routeLayer);
    </script>
  </body>
</html>
