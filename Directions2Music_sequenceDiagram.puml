@startuml
!theme plain

' Simplified sequence diagram showing the actual implementation
' User interacts with Web Client, which calls MCP Server that orchestrates LLM and ElevenLabs

'' Participant colors
skinparam participant {
  BackgroundColor<<User>> LightGoldenRodYellow
  BackgroundColor<<WebClient>> #FFF2CC
  BackgroundColor<<DirectionsComponent>> #E6F2FF
  BackgroundColor<<RoutingService>> #F2E6FF
  BackgroundColor<<MCPClient>> #E1F5FE
  BackgroundColor<<MCPServer>> #FFF0D9
  BackgroundColor<<Gemini>> #E8F8E8
  BackgroundColor<<ElevenLabs>> #FFE6E6
}

actor User <<User>>
participant "Web Client\n(index.html)" as WebClient <<WebClient>>
participant "Directions\nComponent" as DirectionsComponent <<DirectionsComponent>>
participant "Esri Routing\nService" as RoutingService <<RoutingService>>
participant "MCP Client\n(orchestrator)" as MCPClient <<MCPClient>>
participant "MCP Server\n(Node.js)" as MCPServer <<MCPServer>>
participant "Google Gemini\n(LLM)" as Gemini <<Gemini>>
participant "ElevenLabs\n(Music API)" as ElevenLabs <<ElevenLabs>>

== Get Directions ==
User -> WebClient: Click on map to set start/end points
WebClient -> DirectionsComponent: createRoute()
DirectionsComponent -> RoutingService: Request route with waypoints
RoutingService --> DirectionsComponent: Route result with directions & geometry
DirectionsComponent --> WebClient: Directions array + route graphics
note right of WebClient #lightblue
 Web client extracts:
 - Human-readable text directions
 - Route graphics (polylines, points)
 - Route metadata
end note

== Find Musical Style ==
WebClient -> MCPClient: Request music generation\n(directions text array + route graphics)
MCPClient -> MCPServer: Call "find-musical-style" tool\n(directions text array)
MCPServer -> Gemini: Analyze directions for cultural context
note right of Gemini #lightgreen
 Gemini analyzes location/culture from directions:
 - Street names, place names
 - Geographic context
 - Cultural references
 â†’ Returns StyleCard with genre, mood, instrumentation
end note
Gemini --> MCPServer: StyleCard (genre, mood, BPM, etc.)
MCPServer --> MCPClient: Musical style description

== Generate Music ==
MCPClient -> MCPServer: Call "generate-music" tool\n(StyleCard + lyrics + routeGraphics)
MCPServer -> MCPServer: Create composition plan from StyleCard
MCPServer -> ElevenLabs: Create composition plan
ElevenLabs --> MCPServer: Enhanced composition plan
MCPServer -> ElevenLabs: Generate music with plan
note right of ElevenLabs #pink
 ElevenLabs process:
 1. Refine composition plan with vocal focus
 2. Generate music with lyrics = directions
 3. Return audio stream
end note
ElevenLabs --> MCPServer: Audio stream + metadata

== Save and Respond ==
MCPServer -> MCPServer: Save audio to /generated-music/audio/
MCPServer -> MCPServer: Save metadata to /generated-music/metadata/
MCPServer -> MCPServer: Save route graphics to /generated-music/route-graphics/
MCPServer --> MCPClient: Audio filename + metadata (jobID)
MCPClient --> WebClient: Job completion with audio filename

== Playback ==
WebClient -> MCPServer: GET /audio/{filename}
MCPServer --> WebClient: Audio file stream
WebClient -> WebClient: Load route graphics from routeGraphics data
WebClient -> WebClient: Display route on map
WebClient -> WebClient: Play generated music

== End ==
User <-- WebClient: Route visualized + music playing

@enduml